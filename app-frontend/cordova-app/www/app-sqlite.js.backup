// ============= DATABASE.JS =============
let db = null;

function initDatabase() {
  return new Promise((resolve, reject) => {
    if (!window.sqlitePlugin) {
      reject(new Error('Plugin de SQLite no disponible'));
      return;
    }

    db = window.sqlitePlugin.openDatabase({
      name: 'taller2.db',
      location: 'default'
    });

    db.transaction((tx) => {
      tx.executeSql(`CREATE TABLE IF NOT EXISTS usuarios (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nombre TEXT NOT NULL,
        rut TEXT NOT NULL,
        edad INTEGER
      )`);

      tx.executeSql(`CREATE TABLE IF NOT EXISTS ciudades (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nombre TEXT NOT NULL,
        poblacion INTEGER NOT NULL
      )`);

      tx.executeSql(`CREATE TABLE IF NOT EXISTS paises (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        nombre TEXT NOT NULL,
        dirigente TEXT NOT NULL
      )`);

      tx.executeSql('SELECT COUNT(*) as count FROM usuarios', [], (tx, res) => {
        if (res.rows.item(0).count === 0) {
          tx.executeSql('INSERT INTO usuarios (nombre, rut, edad) VALUES (?, ?, ?)', ['Juan P√©rez', '12345678-9', 30]);
          tx.executeSql('INSERT INTO usuarios (nombre, rut, edad) VALUES (?, ?, ?)', ['Mar√≠a Garc√≠a', '98765432-1', 25]);
        }
      });

      tx.executeSql('SELECT COUNT(*) as count FROM ciudades', [], (tx, res) => {
        if (res.rows.item(0).count === 0) {
          tx.executeSql('INSERT INTO ciudades (nombre, poblacion) VALUES (?, ?)', ['Santiago', 5000000]);
          tx.executeSql('INSERT INTO ciudades (nombre, poblacion) VALUES (?, ?)', ['Valpara√≠so', 300000]);
        }
      });

      tx.executeSql('SELECT COUNT(*) as count FROM paises', [], (tx, res) => {
        if (res.rows.item(0).count === 0) {
          tx.executeSql('INSERT INTO paises (nombre, dirigente) VALUES (?, ?)', ['Chile', 'Gabriel Boric']);
          tx.executeSql('INSERT INTO paises (nombre, dirigente) VALUES (?, ?)', ['Argentina', 'Javier Milei']);
        }
      });

    }, (error) => {
      console.error('Error:', error);
      reject(error);
    }, () => {
      console.log('‚úì BD lista');
      resolve(db);
    });
  });
}

function executeSql(sql, params = []) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject(new Error('BD no inicializada'));
      return;
    }
    db.transaction((tx) => {
      tx.executeSql(sql, params, (tx, results) => {
        const rows = [];
        for (let i = 0; i < results.rows.length; i++) {
          rows.push(results.rows.item(i));
        }
        resolve(rows);
      }, (tx, error) => {
        reject(error);
      });
    });
  });
}

function executeInsert(sql, params = []) {
  return new Promise((resolve, reject) => {
    if (!db) {
      reject(new Error('BD no inicializada'));
      return;
    }
    db.transaction((tx) => {
      tx.executeSql(sql, params, (tx, results) => {
        resolve(results.insertId);
      }, (tx, error) => {
        reject(error);
      });
    });
  });
}

// ============= SERVICIOS =============
async function getCiudades() {
  return await executeSql('SELECT * FROM ciudades ORDER BY nombre');
}

async function createCiudad(data) {
  const id = await executeInsert(
    'INSERT INTO ciudades (nombre, poblacion) VALUES (?, ?)',
    [data.nombre, data.poblacion]
  );
  return { id, ...data };
}

async function getPaises() {
  return await executeSql('SELECT * FROM paises ORDER BY nombre');
}

async function createPais(data) {
  const id = await executeInsert(
    'INSERT INTO paises (nombre, dirigente) VALUES (?, ?)',
    [data.nombre, data.dirigente]
  );
  return { id, ...data };
}

async function getUsuarios() {
  return await executeSql('SELECT * FROM usuarios ORDER BY nombre');
}

async function createUsuario(data) {
  const id = await executeInsert(
    'INSERT INTO usuarios (nombre, rut, edad) VALUES (?, ?, ?)',
    [data.nombre, data.rut, data.edad || null]
  );
  return { id, ...data };
}

// ============= MAIN APP =============
const content = document.getElementById('content');
const btnCiudades = document.getElementById('btn-ciudades');
const btnPaises = document.getElementById('btn-paises');
const btnUsuarios = document.getElementById('btn-usuarios');

let currentView = 'ciudades';

function showNotification(message, type = 'success') {
  const notification = document.createElement('div');
  notification.className = `fixed top-24 right-4 z-50 p-4 rounded-lg shadow-lg ${
    type === 'success' ? 'bg-green-500' : 'bg-red-500'
  } text-white font-medium fade-in`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

function renderList(title, items, fields, formFields, onSubmit) {
  content.innerHTML = '';
  
  const header = document.createElement('div');
  header.className = 'flex items-center justify-between mb-4';
  header.innerHTML = `
    <h2 class="text-2xl font-bold">${title}</h2>
    <button id="btn-add" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium">
      + Nuevo
    </button>
  `;
  content.appendChild(header);

  const formContainer = document.createElement('div');
  formContainer.id = 'form-container';
  formContainer.className = 'hidden mb-6 bg-white p-4 rounded-lg shadow-lg border-2 border-blue-200';
  
  const form = document.createElement('form');
  form.className = 'space-y-3';
  form.innerHTML = `
    ${formFields.map(field => `
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">${field.label}</label>
        <input 
          type="${field.type || 'text'}" 
          name="${field.name}" 
          required
          placeholder="${field.placeholder || ''}"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        />
      </div>
    `).join('')}
    <div class="flex gap-2">
      <button type="submit" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-medium">
        Guardar
      </button>
      <button type="button" id="btn-cancel" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg">
        Cancelar
      </button>
    </div>
  `;
  
  formContainer.appendChild(form);
  content.appendChild(formContainer);

  header.querySelector('#btn-add').addEventListener('click', () => {
    formContainer.classList.toggle('hidden');
  });

  form.querySelector('#btn-cancel').addEventListener('click', () => {
    form.reset();
    formContainer.classList.add('hidden');
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => { data[key] = value; });
    
    try {
      await onSubmit(data);
      form.reset();
      formContainer.classList.add('hidden');
      showNotification('‚úÖ Elemento creado');
      loadCurrentView();
    } catch (error) {
      console.error(error);
      showNotification('‚ùå Error: ' + error.message, 'error');
    }
  });

  const list = document.createElement('div');
  list.className = 'space-y-3';

  if (!items || items.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'text-center py-12 bg-green-50 rounded-lg border-2 border-dashed border-green-300';
    empty.innerHTML = `
      <div class="text-4xl mb-2">‚úÖ</div>
      <p class="text-green-600 font-bold">BD Conectada</p>
      <p class="text-gray-600 text-sm mt-2">Vac√≠a - Agrega elementos con "+ Nuevo"</p>
    `;
    list.appendChild(empty);
  } else {
    items.forEach((item, index) => {
      const card = document.createElement('div');
      card.className = 'p-4 bg-white rounded-lg shadow border';
      
      const fieldsHTML = fields.map(f => `
        <div class="flex justify-between py-1">
          <span class="text-sm font-medium text-gray-600">${f.label}:</span>
          <span class="text-sm text-gray-900 font-semibold">${item[f.key] ?? 'N/A'}</span>
        </div>
      `).join('');
      
      card.innerHTML = `
        <div class="flex justify-between mb-2">
          <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-bold rounded">#${index + 1}</span>
          ${item.id ? `<span class="text-xs text-gray-400">ID: ${item.id}</span>` : ''}
        </div>
        ${fieldsHTML}
      `;
      
      list.appendChild(card);
    });
  }

  content.appendChild(list);
}

async function showCiudades() {
  currentView = 'ciudades';
  try {
    content.innerHTML = '<div class="text-center py-8">Cargando...</div>';
    const ciudades = await getCiudades();
    renderList(
      'üèôÔ∏è Ciudades',
      ciudades,
      [
        { label: 'Nombre', key: 'nombre' },
        { label: 'Poblaci√≥n', key: 'poblacion' }
      ],
      [
        { name: 'nombre', label: 'Nombre de la Ciudad', placeholder: 'Ej: Santiago' },
        { name: 'poblacion', label: 'Poblaci√≥n', type: 'number', placeholder: 'Ej: 5000000' }
      ],
      createCiudad
    );
  } catch (e) {
    console.error(e);
    content.innerHTML = `<div class="text-red-500 p-4">Error: ${e.message}</div>`;
  }
}

async function showPaises() {
  currentView = 'paises';
  try {
    content.innerHTML = '<div class="text-center py-8">Cargando...</div>';
    const paises = await getPaises();
    renderList(
      'üåç Pa√≠ses',
      paises,
      [
        { label: 'Nombre', key: 'nombre' },
        { label: 'Dirigente', key: 'dirigente' }
      ],
      [
        { name: 'nombre', label: 'Nombre del Pa√≠s', placeholder: 'Ej: Chile' },
        { name: 'dirigente', label: 'Dirigente', placeholder: 'Ej: Presidente...' }
      ],
      createPais
    );
  } catch (e) {
    console.error(e);
    content.innerHTML = `<div class="text-red-500 p-4">Error: ${e.message}</div>`;
  }
}

async function showUsuarios() {
  currentView = 'usuarios';
  try {
    content.innerHTML = '<div class="text-center py-8">Cargando...</div>';
    const usuarios = await getUsuarios();
    renderList(
      'üë• Usuarios',
      usuarios,
      [
        { label: 'Nombre', key: 'nombre' },
        { label: 'RUT', key: 'rut' },
        { label: 'Edad', key: 'edad' }
      ],
      [
        { name: 'nombre', label: 'Nombre Completo', placeholder: 'Ej: Juan P√©rez' },
        { name: 'rut', label: 'RUT', placeholder: 'Ej: 12345678-9' },
        { name: 'edad', label: 'Edad', type: 'number', placeholder: 'Ej: 25' }
      ],
      createUsuario
    );
  } catch (e) {
    console.error(e);
    content.innerHTML = `<div class="text-red-500 p-4">Error: ${e.message}</div>`;
  }
}

function loadCurrentView() {
  if (currentView === 'usuarios') showUsuarios();
  else if (currentView === 'paises') showPaises();
  else if (currentView === 'ciudades') showCiudades();
}

// Inicializar
document.addEventListener('deviceready', async () => {
  console.log('‚úì Cordova listo');
  
  try {
    await initDatabase();
    console.log('‚úì BD inicializada');
    
    btnCiudades.addEventListener('click', showCiudades);
    btnPaises.addEventListener('click', showPaises);
    btnUsuarios.addEventListener('click', showUsuarios);
    
    await showCiudades();
  } catch (error) {
    console.error('Error:', error);
    content.innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`;
  }
}, false);